<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WashX - Customer Management</title>
    <link rel="stylesheet" href="/styles/style.css">
    <style>
        body {
            display: flex;
            overflow: hidden;
        }

        .main-content {
            flex-grow: 1;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar {
            flex-shrink: 0;
            height: 100vh;
        }

        .customer-list {
            display: flex;
            flex-direction: column;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .list-header, .list-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 2fr 1fr 1.2fr 1.2fr;
            gap: 16px;
            padding: 12px 16px;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .list-row:last-child {
            border-bottom: none;
        }

        button:focus,
        input:focus,
        select:focus,
        textarea:focus,
        a:focus {
            outline: none;
            box-shadow: none;
        }

        .list-header {
            flex-shrink: 0;
            background-color: #ffffff;
            z-index: 1;
            font-weight: 600;
        }
        
        .sortable-header {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .sortable-header:hover {
            color: #4f46e5;
        }

        .sort-icon::after {
            content: '‚Üï';
            font-size: 0.9em;
            color: #9ca3af;
            display: inline-block;
            width: 1em;
            text-align: center;
        }

        .sortable-header.asc .sort-icon::after {
            content: '‚Üë';
            color: #4f46e5;
        }

        .sortable-header.desc .sort-icon::after {
            content: '‚Üì';
            color: #4f46e5;
        }

        fieldset {
            border: none;
            padding: 0;
            margin: 0;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 28px; 
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            width: 100%;
            position: relative;
        }

        #orderModal .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        .order-items-list {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .order-item-row,
        .order-item-header {
            display: grid;
            gap: 10px;
            padding: 8px 12px;
            align-items: center;
        }

        .order-item-header {
            font-weight: 600;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .order-item-row:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .order-item-row .item-details {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .remove-item-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 1.2rem;
            justify-self: end;
        }

        #orderTotal {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 1rem;
            text-align: right;
        }

        .radio-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            border: 1px solid #d1d5db;
            padding: 12px;
            border-radius: 6px;
            max-height: 160px;
            overflow-y: auto;
            background-color: #fff;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item label {
            font-weight: normal;
            color: #374151;
        }

        .radio-item input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: #4f46e5;
        }

        #serviceInputContainer {
            background-color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .sub-item-row {
            display: grid;
            grid-template-columns: 1fr 90px 80px;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }

        .sub-item-row label {
            font-weight: 500;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }

        .status-new {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-pick-up-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-in-progress {
            background-color: #e0e7ff;
            color: #3730a3;
        }

        .status-delivery-pending {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-delivered,
        .status-collected {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-cancelled {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .status-collection-pending {
            background-color: #FEF9C3;
            color: #854D0E;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 10px 15px;
        }

        .logout-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #d1d5db;
            padding: 12px 15px;
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .logout-link .nav-icon {
            margin-right: 12px;
        }

        .logout-link:hover {
            background-color: #be123c;
            color: #fff;
        }

        .service-type-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .service-type-label {
            display: block;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            flex-grow: 1;
            text-align: center;
        }

        .service-type-label:has(input:checked) {
            background-color: #e0e7ff;
            border-color: #4f46e5;
            color: #3730a3;
            font-weight: 600;
        }

        .service-type-label input {
            display: none;
        }

        .service-type-label small {
            display: block;
            font-weight: 400;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .service-type-label:has(input:checked) small {
            color: #4338ca;
        }

        .service-type-tag {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 10px;
            margin-left: 8px;
            vertical-align: middle;
        }

        .service-type-tag-standard {
            background-color: #e5e7eb;
            color: #4b5563;
        }

        .service-type-tag-express {
            background-color: #c7d2fe;
            color: #3730a3;
        }
        
        .service-type-tag-superfast {
            background-color: #fecaca;
            color: #991b1b;
        }

        .slot-options-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .slot-card {
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .slot-card.available {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }

        .slot-card.full {
            border-color: #ef4444;
            background-color: #fef2f2;
            color: #991b1b;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .slot-card.selected {
            border-color: #4f46e5;
            background-color: #e0e7ff;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
            transform: translateY(-2px);
        }

        .slot-card-name {
            font-weight: 600;
            display: block;
        }

        .slot-card-availability {
            font-size: 0.8rem;
            color: #4b5563;
            display: block;
            margin-top: 4px;
        }

        .slot-card.full .slot-card-availability {
            color: #b91c1c;
            font-weight: 500;
        }

        .slot-card.available .slot-card-availability {
            color: #15803d;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .action-link {
            padding: 4px 10px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }

        .action-link:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>

<body>
    <nav class="sidebar">
        <div>
            <div class="logo">
                <div class="logo-icon">WX</div>
                <div class="logo-text">WashX<br><span style="font-size: 12px; color: #6b7280;">Admin Portal</span></div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="/home.html" class="nav-link">
                        <div class="nav-icon">üìä</div>Dashboard
                    </a></li>
                <li class="nav-item"><a href="/orders.html" class="nav-link">
                        <div class="nav-icon">üì¶</div>Orders
                    </a></li>
                <li class="nav-item"><a href="/customers.html" class="nav-link active">
                        <div class="nav-icon">üë•</div>Customers
                    </a></li>
                <li class="nav-item"><a href="/slots.html" class="nav-link">
                        <div class="nav-icon">üè¢</div>Slots
                    </a></li>
                <li class="nav-item"><a href="#" class="nav-link">
                        <div class="nav-icon">üîî</div>Notifications
                    </a></li>
                <li class="nav-item"><a href="/reports.html" class="nav-link">
                        <div class="nav-icon">üìà</div>Reports
                    </a></li>
                <li class="nav-item"><a href="/staff.html" class="nav-link">
                        <div class="nav-icon">üë®‚Äçüíº</div>Staff
                    </a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <a href="/logout" class="logout-link">
                <div class="nav-icon">üö™</div>Logout
            </a>
        </div>
    </nav>
    <main class="main-content">
        <header class="header">
            <div>
                <h1 class="page-title">Customer Management</h1>
                <p class="page-subtitle">Manage customer accounts and create bookings</p>
            </div>
            <div class="header-actions">
                <button class="add-button" id="openAddModalBtn">
                    <span>+</span> Add Customer
                </button>
            </div>
        </header>

        <div class="search-bar">
            <div class="search-input-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Search by name, phone, society, or pincode...">
            </div>
        </div>

        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <span style="margin-left: 12px;">Loading customers...</span>
        </div>

        <div class="customer-list" id="customerListContainer" style="display: none;">
             <div class="list-header">
                <div>Customer</div>
                <div>Contact</div>
                <div>Society</div>
                <div>Address & Pincode</div>
                <div class="sortable-header" data-sort-key="orderCount">
                    <span>Orders</span>
                    <span class="sort-icon"></span>
                </div>
                <div class="sortable-header" data-sort-key="totalSpent">
                    <span>Total Spent</span>
                    <span class="sort-icon"></span>
                </div>
                <div>Actions</div>
            </div>
            <div id="customerList"></div>
            <div id="scrollLoader" class="loading" style="display: none; padding: 20px;">
                <div class="spinner"></div>
                <span style="margin-left: 12px;">Loading more customers...</span>
            </div>
        </div>
    </main>

    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New Customer</h2>
                <button class="close-button" id="closeModalBtn">&times;</button>
            </div>
            <form id="customerForm">
                <input type="hidden" id="customer-id" name="id">
                <fieldset id="customerFormFieldset">
                    <div class="form-group">
                        <label class="form-label" for="pincode">Pincode</label>
                        <input type="text" class="form-input" id="pincode" name="pincode"
                            placeholder="Enter 6-digit pincode" maxlength="6" required pattern="\d{6}"
                            title="Pincode must be 6 digits.">
                        <p id="pincodeMessage"
                            style="font-weight: 500; font-size: 0.8rem; margin-top: 4px; display: none;"></p>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="phone">Phone Number</label>
                        <input type="tel" class="form-input" id="phone" name="phone" required maxlength="10"
                            pattern="\d{10}" title="Phone number must be 10 digits.">
                        <p id="phoneMessage" style="color: #ef4444; font-size: 0.8rem; margin-top: 4px; display: none;"></p>
                    </div>
                    <div class="form-group"><label class="form-label" for="customerName">Full Name</label><input
                            type="text" class="form-input" id="customerName" name="customerName" required></div>
                    <div class="form-group">
                        <label class="form-label">Society</label>
                        <div id="societySelectionContainer" class="radio-group">
                            <p style="color: #6b7280; grid-column: 1 / -1;">Enter a valid, serviceable pincode to see
                                societies.</p>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label" for="address">Address (e.g., Flat No,
                            Block)</label><input type="text" class="form-input" id="address" name="address" required placeholder="E.g., A-123, Tower 4"></div>
                </fieldset>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="button" class="btn-primary" id="editBtn">Edit</button>
                    <button type="submit" class="btn-primary" id="submitBtn">Add Customer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="orderModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Create New Order for <span id="orderCustomerName"></span></h2>
                <button class="close-button" id="closeOrderModalBtn">&times;</button>
            </div>
            <form id="orderForm">
                <input type="hidden" id="order-customer-id">
                <input type="hidden" id="pickupSlot" name="pickupSlot">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label" for="deliveryType">Delivery Type</label>
                        <select class="form-select" id="deliveryType" name="deliveryType">
                            <option value="Home Delivery">Home Delivery</option>
                            <option value="Store Pick-up">Store Pick-up</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="orderSource">Order Source</label>
                        <select class="form-select" id="orderSource" name="orderSource">
                            <option value="Call">Call</option>
                            <option value="Walk-in">Walk-in</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">Schedule Pickup?</label>
                    <div
                        style="display: flex; gap: 24px; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px;">
                        <label class="radio-item" style="flex-grow: 1;">
                            <input type="radio" name="schedulePickup" value="yes" checked> Yes
                        </label>
                        <label class="radio-item" style="flex-grow: 1;">
                            <input type="radio" name="schedulePickup" value="no"> No
                        </label>
                    </div>
                </div>

                <hr style="margin: 20px 0;">
                <h3 style="margin-bottom: 10px;">Add Service to Order</h3>
                <div class="form-group">
                    <label class="form-label" style="margin-bottom: 8px;">Delivery Speed</label>
                    <div class="service-type-group" id="serviceTypeGroup">
                        <label class="service-type-label">
                            <input type="radio" name="serviceType" value="Standard" checked>
                            Standard <small>Regular delivery</small>
                        </label>
                        <label class="service-type-label">
                            <input type="radio" name="serviceType" value="Express">
                            Express <small>~25% faster, 1.5x price</small>
                        </label>
                        <label class="service-type-label">
                            <input type="radio" name="serviceType" value="Superfast">
                            Superfast <small>~50% faster, 2x price</small>
                        </label>
                    </div>
                </div>

                <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex-grow: 1;">
                        <label class="form-label" for="serviceCategorySelect">Select Service Category</label>
                        <select class="form-select" id="serviceCategorySelect">
                            <option value="">-- Select a category --</option>
                        </select>
                    </div>
                </div>
                <div id="serviceInputContainer" style="display: none;"></div>
                <h3 style="margin-top: 20px; margin-bottom: 10px;">Current Order Items</h3>
                <div class="order-items-list">
                    <div class="order-item-header" style="grid-template-columns: 1fr 40px;">
                        <div>Service Details</div>
                        <div></div>
                    </div>
                    <div id="orderItemsContainer"></div>
                </div>
                <div id="orderTotal">Total Amount: ‚Çπ0.00</div>
                <hr style="margin: 20px 0;">
                <div id="pickupSection">
                    <h3 style="margin-bottom: 10px;">Pickup Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; align-items: flex-start;">
                        <div class="form-group">
                            <label class="form-label" for="pickupDate">Pickup Date</label>
                            <input type="date" class="form-input" id="pickupDate" name="pickupDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="pickupSlotContainer">Pickup Slot</label>
                            <div id="pickupSlotContainer" class="slot-options-container">
                                <p style="grid-column: 1 / -1; color: #6b7280; font-size: 0.9rem;">Select a date to see
                                    available slots.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions" style="margin-top: 20px;">
                    <button type="button" class="btn-secondary" id="cancelOrderBtn">Cancel</button>
                    <button type="submit" class="btn-primary" id="submitOrderBtn">Create Order</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customerOrdersModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="customerOrdersModalTitle">Order History</h2>
                <button class="close-button" id="closeCustomerOrdersModalBtn">&times;</button>
            </div>
            <div class="modal-body" style="padding-top: 1rem;">
                <div class="order-items-list">
                    <div class="order-item-header" style="grid-template-columns: 1fr 1.5fr 1.2fr 3fr 1.2fr 1fr;">
                        <div>Order ID</div>
                        <div>Order Date</div>
                        <div>Service Type</div>
                        <div>Items Summary</div>
                        <div>Status</div>
                        <div>Amount</div>
                    </div>
                    <div id="customerOrdersListContainer" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div id="customerTotalSpent"
                    style="font-size: 1.2rem; font-weight: bold; margin-top: 1rem; text-align: right;">
                    Total Spent: ‚Çπ0.00
                </div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        //                 STATE AND DOM ELEMENTS
        // =================================================================
        let allCustomers = [], allSocieties = [], availableServices = [], currentOrderItems = [];
        let currentPage = 1, isLoading = false, hasMoreCustomers = true, currentSearchTerm = '', searchTimeout, phoneCheckTimeout;
        let currentSortKey = '', currentSortOrder = '';
        const CUSTOMERS_PER_PAGE = 20;
        const customerModal = document.getElementById('customerModal'), customerForm = document.getElementById('customerForm'), modalTitle = document.getElementById('modalTitle'), submitBtn = document.getElementById('submitBtn'), customerIdInput = document.getElementById('customer-id'), customerFormFieldset = document.getElementById('customerFormFieldset'), editBtn = document.getElementById('editBtn'), cancelBtn = document.getElementById('cancelBtn'), orderModal = document.getElementById('orderModal'), orderForm = document.getElementById('orderForm'), searchInput = document.getElementById('searchInput'), customerOrdersModal = document.getElementById('customerOrdersModal'), serviceTypeGroup = document.getElementById('serviceTypeGroup'), pincodeInput = document.getElementById('pincode'), pincodeMessage = document.getElementById('pincodeMessage'), societyContainer = document.getElementById('societySelectionContainer'), pickupSection = document.getElementById('pickupSection'), customerListDiv = document.getElementById('customerList'), scrollLoader = document.getElementById('scrollLoader'), mainContent = document.querySelector('.main-content'), phoneInput = document.getElementById('phone'), phoneMessage = document.getElementById('phoneMessage');
        const pickupSlotContainer = document.getElementById('pickupSlotContainer');
        const pickupSlotInput = document.getElementById('pickupSlot');

        // =================================================================
        //                 CUSTOMER DATA FETCHING & RENDERING
        // =================================================================
        async function fetchCustomers(isInitialLoad = false) {
            if (isLoading) return;
            isLoading = true;
            if (isInitialLoad) {
                document.getElementById('loadingState').style.display = 'flex';
                document.getElementById('customerListContainer').style.display = 'none';
            } else {
                scrollLoader.style.display = 'flex';
            }
            try {
                let url = `/api/customers?page=${currentPage}&limit=${CUSTOMERS_PER_PAGE}&search=${encodeURIComponent(currentSearchTerm)}`;
                if (currentSortKey && currentSortOrder) {
                    url += `&sortKey=${currentSortKey}&sortOrder=${currentSortOrder}`;
                }

                const response = await fetch(url);
                if (response.status === 401) return window.location.href = '/';
                const data = await response.json();

                if (isInitialLoad) {
                    allCustomers = [];
                    customerListDiv.innerHTML = '';
                }

                allCustomers.push(...data.customers);
                appendCustomersToDOM(data.customers);

                hasMoreCustomers = data.hasMore;
                if (!hasMoreCustomers) {
                    scrollLoader.style.display = 'none';
                }

                if (isInitialLoad && data.customers.length === 0) {
                    const message = currentSearchTerm ? 'No customers found for your search.' : 'No customers found. Click "Add Customer" to get started.';
                    customerListDiv.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1; padding: 40px;"><h3>${message}</h3></div>`;
                }

            } catch (error) {
                console.error('Failed to fetch customers:', error);
                customerListDiv.innerHTML = `<div class="empty-state"><h3>‚ö†Ô∏è Error</h3><p>Could not load customers. Please refresh.</p></div>`;
            } finally {
                isLoading = false;
                if (isInitialLoad) {
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('customerListContainer').style.display = 'block';
                } else {
                    scrollLoader.style.display = 'none';
                }
            }
        }

        function appendCustomersToDOM(customersToAppend) {
            const customersHTML = customersToAppend.map((customer) => {
                const currentAddressObj = customer.addresses?.find(a => a.isCurrent) || customer.addresses?.[0];
                const societyName = currentAddressObj?.society?.name || 'N/A';
                const addressLine = currentAddressObj?.address || 'N/A';
                const pincode = currentAddressObj?.pincode || 'N/A';
                const memberSince = new Date(customer.createdAt || Date.now()).toLocaleDateString("en-IN");
                const initials = (customer.customerName || '').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const safeCustomerName = customer.customerName.replace(/'/g, "\\'");

                const totalSpentFormatted = (customer.totalSpent || 0).toFixed(2);

                return `
                    <div class="list-row">
                        <div class="customer-cell">
                            <div class="avatar">${initials}</div>
                            <div>
                                <strong>${customer.customerName}</strong>
                                <small>Member since ${memberSince}</small>
                            </div>
                        </div>
                        <div class="contact-cell">
                            <span>üìû ${customer.phone || 'N/A'}</span>
                        </div>
                        <div>
                            <strong>${societyName}</strong>
                        </div>
                        <div>
                            <small>${addressLine}, ${pincode}</small>
                        </div>
                        <div class="orders-cell">
                            <a href="#" class="action-link" onclick="event.preventDefault(); showCustomerOrders('${customer._id}', '${safeCustomerName}')">
                                ${customer.orderCount || 0} orders
                            </a>
                        </div>
                        <div>
                            <strong>‚Çπ${totalSpentFormatted}</strong>
                        </div>
                        <div class="actions-cell">
                            <a href="#" onclick="openOrderModal('${customer._id}')" class="action-link" style="color: #3b82f6;">üìñ Book</a>
                            <a href="#" onclick="openModalForView('${customer._id}')" class="action-link">üëÅÔ∏è View</a>
                        </div>
                    </div>`;
            }).join('');
            customerListDiv.insertAdjacentHTML('beforeend', customersHTML);
        }

        function resetAndFetchCustomers() { currentPage = 1; hasMoreCustomers = true; mainContent.scrollTop = 0; fetchCustomers(true); }

        function updateSortIcons() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('asc', 'desc');
                if (header.dataset.sortKey === currentSortKey) {
                    header.classList.add(currentSortOrder);
                }
            });
        }

        // =================================================================
        //                 PINCODE, SOCIETY, MODALS, etc.
        // =================================================================
        function renderSocieties(societies, selectedSocietyId = null) {
            if (societies.length === 0) { societyContainer.innerHTML = `<p style="color: #6b7280; grid-column: 1 / -1;">Enter a valid, serviceable pincode to see societies.</p>`; return; }
            societyContainer.innerHTML = societies.map(society => `<div class="radio-item"><input type="radio" id="society-${society._id}" name="society" value="${society._id}" required ${society._id === selectedSocietyId ? 'checked' : ''}><label for="society-${society._id}">${society.name}</label></div>`).join('');
        }

        async function handlePincodeChange() {
            const pincode = pincodeInput.value;
            if (pincode.length < 6) {
                pincodeMessage.style.display = 'none';
                renderSocieties([]);
                return;
            }

            try {
                const response = await fetch(`/api/societies/by-pincode/${pincode}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch societies.');
                }
                const serviceableSocieties = await response.json();

                if (serviceableSocieties && serviceableSocieties.length > 0) {
                    pincodeMessage.textContent = 'Serviceable';
                    pincodeMessage.style.color = '#16a34a';
                    pincodeMessage.style.display = 'block';
                    renderSocieties(serviceableSocieties);
                } else {
                    pincodeMessage.textContent = 'Non Serviceable';
                    pincodeMessage.style.color = '#ef4444';
                    pincodeMessage.style.display = 'block';
                    renderSocieties([]);
                }
            } catch (error) {
                console.error("Pincode check failed:", error);
                pincodeMessage.textContent = 'Error checking pincode.';
                pincodeMessage.style.color = '#ef4444';
                pincodeMessage.style.display = 'block';
                renderSocieties([]);
            }
        }

        function setFormState(mode) {
            customerFormFieldset.disabled = (mode === 'view');
            modalTitle.textContent = mode === 'view' ? 'View Customer Details' : (mode === 'edit' ? 'Edit Customer Details' : 'Add New Customer');
            submitBtn.style.display = mode === 'view' ? 'none' : 'inline-block'; submitBtn.textContent = mode === 'edit' ? 'Save Changes' : 'Add Customer';
            cancelBtn.textContent = mode === 'view' ? 'Close' : 'Cancel'; editBtn.style.display = mode === 'view' ? 'inline-block' : 'none';
        }
        function openModalForAdd() {
            customerForm.reset();
            customerIdInput.value = '';
            renderSocieties([]);
            pincodeMessage.style.display = 'none';
            setFormState('add');
            phoneMessage.style.display = 'none';
            submitBtn.disabled = false;
            customerModal.style.display = 'block';
        }
        window.openModalForView = (id) => {
            const customer = allCustomers.find(c => c._id === id); if (!customer) return;
            const currentAddress = customer.addresses.find(a => a.isCurrent) || customer.addresses[0];
            customerForm.reset(); customerIdInput.value = customer._id;
            document.getElementById('customerName').value = customer.customerName; document.getElementById('phone').value = customer.phone || '';
            if (currentAddress) {
                const societyDoc = currentAddress.society;
                let flatBlockAddress = currentAddress.address || '';

                if (societyDoc && societyDoc.additionalAddress && flatBlockAddress.endsWith(societyDoc.additionalAddress)) {
                    flatBlockAddress = flatBlockAddress.slice(0, -societyDoc.additionalAddress.length).replace(/,\s*$/, '');
                }

                document.getElementById('address').value = flatBlockAddress;
                pincodeInput.value = currentAddress.pincode || '';
                pincodeMessage.style.display = 'none';
                const societyId = societyDoc?._id || societyDoc;
                if (societyId) { societyContainer.innerHTML = `<p style="padding: 8px 0; color: #111827; font-weight: 500;">${societyDoc.name}</p>`; } else { societyContainer.innerHTML = `<p style="color: #6b7280;">No society assigned.</p>`; }
            } else { pincodeInput.value = ''; document.getElementById('address').value = ''; societyContainer.innerHTML = `<p style="color: #6b7280;">No address on file.</p>`; pincodeMessage.style.display = 'none'; }
            setFormState('view'); customerModal.style.display = 'block';
        };

        function closeCustomerModal() { customerModal.style.display = 'none'; }
        window.openOrderModal = (id) => {
            const customer = allCustomers.find(c => c._id === id); if (!customer) return;
            orderForm.reset(); currentOrderItems = []; renderOrderItems();
            document.getElementById('serviceCategorySelect').value = ''; document.getElementById('serviceInputContainer').style.display = 'none';
            document.getElementById('order-customer-id').value = customer._id;
            document.getElementById('orderCustomerName').textContent = customer.customerName;
            const pickupDateInput = document.getElementById('pickupDate');
            const today = new Date(); const maxDate = new Date(); maxDate.setDate(today.getDate() + 14);
            pickupDateInput.setAttribute('min', today.toISOString().split('T')[0]); pickupDateInput.setAttribute('max', maxDate.toISOString().split('T')[0]);
            pickupDateInput.value = '';
            pickupSlotContainer.innerHTML = `<p style="grid-column: 1 / -1; color: #6b7280; font-size: 0.9rem;">Select a date to see available slots.</p>`;
            document.querySelector('input[name="schedulePickup"][value="yes"]').checked = true;
            pickupSection.style.display = 'block'; document.getElementById('pickupDate').required = true; pickupSlotInput.required = true;
            orderModal.style.display = 'block';
        };
        function closeOrderModal() { orderModal.style.display = 'none'; }
        function renderOrderItems() {
            const container = document.getElementById('orderItemsContainer');
            if (currentOrderItems.length === 0) { container.innerHTML = `<div style="text-align: center; padding: 20px; color: #6b7280;">No services added yet.</div>`; } else {
                container.innerHTML = currentOrderItems.map((item, index) => {
                    const service = availableServices.find(s => s._id === item.serviceCategoryID);
                    return `<div class="order-item-row" style="grid-template-columns: 1fr 40px;"><div><strong>${service.categoryName}<span class="service-type-tag service-type-tag-${item.serviceType.toLowerCase()}">${item.serviceType}</span></strong><div class="item-details">Details to be added after pickup.</div></div><button type="button" class="remove-item-btn" onclick="removeOrderItem(${index})">√ó</button></div>`;
                }).join('');
            }
            updateOrderTotal();
        }
        function removeOrderItem(index) { currentOrderItems.splice(index, 1); renderOrderItems(); }
        function updateOrderTotal() { const total = currentOrderItems.reduce((acc, item) => acc + item.itemTotal, 0); document.getElementById('orderTotal').textContent = `Total Amount: ${total > 0 ? `‚Çπ${total.toFixed(2)}` : '‚Çπ--'}`; }
        
        function renderServiceInputs(service) {
            const container = document.getElementById('serviceInputContainer');
            const { value: selectedServiceType } = document.querySelector('input[name="serviceType"]:checked');
            
            let tat;
            switch(selectedServiceType) {
                case 'Express':
                    tat = service.expressTAT;
                    break;
                case 'Superfast':
                    tat = service.superfastTAT;
                    break;
                default:
                    tat = service.standardTAT;
            }

            let content = `<p><strong>Selected: ${service.categoryName}</strong> <span style="font-size:0.9rem; color: #4f46e5;">(Service Time: ${tat})</span></p><p style="font-size:0.8rem; color: #6b7280;">Weight/item counts will be added after pickup during the 'In-Progress' stage.</p>`;
            container.innerHTML = content + `<button type="button" class="btn-primary" id="addServiceItemBtn" style="margin-top: 16px;">Add Service to Order</button>`;
            container.style.display = 'block';
            document.getElementById('addServiceItemBtn').addEventListener('click', () => addServiceToOrder(service));
        }

        function addServiceToOrder(service) {
            const newItem = { serviceCategoryID: service._id, itemTotal: 0, serviceType: document.querySelector('input[name="serviceType"]:checked').value };
            const serviceName = availableServices.find(s => s._id === service._id)?.categoryName || 'Unknown Service';
            if (currentOrderItems.some(item => item.serviceCategoryID === newItem.serviceCategoryID && item.serviceType === newItem.serviceType)) { return alert(`The '${serviceName} (${newItem.serviceType})' service is already in the order. Quantities can be added later.`); }
            switch (service.pricingModel) { 
                case 'PerKg': newItem.weightInKg = 0; break; 
                case 'PerPair': newItem.pairCount = 0; break; 
                case 'PerItem': newItem.subItems = []; break; 
            }
            currentOrderItems.push(newItem); renderOrderItems();
            document.getElementById('serviceCategorySelect').value = ''; document.getElementById('serviceInputContainer').style.display = 'none';
        }
    async function showCustomerOrders(customerId, customerName) {
            const modalTitle = document.getElementById('customerOrdersModalTitle');
            const listContainer = document.getElementById('customerOrdersListContainer');
            const totalSpentEl = document.getElementById('customerTotalSpent');

            modalTitle.textContent = `Order History for ${customerName}`;
            listContainer.innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
            totalSpentEl.textContent = 'Total Spent: ‚Çπ0.00';
            customerOrdersModal.style.display = 'block';

            try {
                const response = await fetch(`/api/customers/${customerId}/orders`);
                const orders = await response.json();

                if (orders.length === 0) {
                    listContainer.innerHTML = `<div class="empty-state">This customer has no orders.</div>`;
                    return;
                }

                const totalSpending = orders
                    .filter(order => order.orderStatus !== 'Cancelled')
                    .reduce((sum, order) => sum + order.billAmount, 0);
                
                totalSpentEl.textContent = `Total Spent: ‚Çπ${totalSpending.toFixed(2)}`;
                
                listContainer.innerHTML = orders.map(o => { 
                    const itemSummary = o.items.map(i => `${i.serviceCategoryID.categoryName} ` + (i.weightInKg ? `(${i.weightInKg}kg)` : i.pairCount ? `(${i.pairCount}p)` : `(${i.subItems.reduce((a, s) => a + s.quantity, 0)}i)`)).join('; '); 
                    return `<div class="order-item-row" style="grid-template-columns: 1fr 1.5fr 1.2fr 3fr 1.2fr 1fr;"><div><strong>${o.orderId}</strong></div><div>${new Date(o.orderedOn).toLocaleDateString('en-IN')}</div><div><span class="service-type-tag service-type-tag-${o.items[0].serviceType.toLowerCase()}" style="margin-left:0;">${o.items[0].serviceType}</span></div><div class="item-details">${itemSummary}</div><div><span class="status-badge status-${o.orderStatus.toLowerCase().replace(/ /g, '-')}">${o.orderStatus}</span></div><div><strong>‚Çπ${o.billAmount.toFixed(2)}</strong></div></div>`; 
                }).join('');

            } catch (e) { 
                listContainer.innerHTML = `<div class="empty-state" style="color:#ef4444;">Error loading history.</div>`; 
            }
        }

        function renderPickupSlots(slots) {
            pickupSlotInput.value = '';
            const pickupSlots = slots.filter(s => s.slotType === 'Pickup');
            if (pickupSlots.length === 0) { pickupSlotContainer.innerHTML = `<p style="grid-column: 1 / -1; color: #6b7280;">No pickup slots available for this date.</p>`; return; }
            pickupSlotContainer.innerHTML = pickupSlots.map(slot => {
                const isFull = slot.bookedCount >= slot.maxCapacity;
                const availableCount = slot.maxCapacity - slot.bookedCount;
                const statusClass = isFull ? 'full' : 'available';
                const availabilityText = isFull ? 'Slot Full' : `${availableCount} of ${slot.maxCapacity} slots available`;
                return `<div class="slot-card ${statusClass}" data-slot-id="${slot._id}" ${isFull ? 'disabled' : ''}>
                        <span class="slot-card-name">${slot.slotName}</span>
                        <span class="slot-card-availability">${availabilityText}</span>
                    </div>`;
            }).join('');
        }

        // =================================================================
        //                   FORM SUBMISSION
        // =================================================================
        customerForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries());
            if (!data.society && customerFormFieldset.disabled === false) { return alert('Please select a society.'); }
            const id = data.id; delete data.id;
            try {
                const res = await fetch(id ? `/api/customers/${id}` : '/api/customers', { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!res.ok) throw new Error((await res.json()).message);
                closeCustomerModal(); resetAndFetchCustomers();
            } catch (error) { alert(`Error: ${error.message}`); }
        });

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault(); if (currentOrderItems.length === 0) return alert('Please add services to the order.');
            const shouldSchedule = document.querySelector('input[name="schedulePickup"]:checked').value === 'yes';
            const orderData = {
                customerID: document.getElementById('order-customer-id').value,
                deliveryType: document.getElementById('deliveryType').value,
                orderSource: document.getElementById('orderSource').value,
                items: currentOrderItems,
                billAmount: currentOrderItems.reduce((acc, item) => acc + item.itemTotal, 0),
                isPickupScheduled: shouldSchedule
            };
            if (shouldSchedule) {
                orderData.pickupDate = document.getElementById('pickupDate').value;
                orderData.pickupSlot = pickupSlotInput.value;
                if (!orderData.pickupDate || !orderData.pickupSlot) { return alert('Pickup Date and Slot are required when scheduling a pickup.'); }
            }
            const btn = document.getElementById('submitOrderBtn'); btn.disabled = true; btn.textContent = 'Creating...';
            try {
                const res = await fetch('/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) });
                if (!res.ok) throw new Error((await res.json()).message);
                const newOrders = await res.json();
                alert(`Success! Order(s) ${newOrders.map(o => o.orderId).join(', ')} created.`);
                closeOrderModal();
                resetAndFetchCustomers();
            } catch (error) { alert(`Error: ${error.message}`); } finally { btn.disabled = false; btn.textContent = 'Create Order'; }
        });

        // =================================================================
        //                   EVENT LISTENERS & INITIALIZATION
        // =================================================================
        searchInput.addEventListener('input', (e) => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { currentSearchTerm = e.target.value; resetAndFetchCustomers(); }, 500); });
        
        mainContent.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = mainContent;
            if (scrollTop + clientHeight >= scrollHeight - 200 && hasMoreCustomers && !isLoading) { currentPage++; fetchCustomers(); }
        });
        
        document.querySelectorAll('input[name="schedulePickup"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const shouldSchedule = e.target.value === 'yes';
                pickupSection.style.display = shouldSchedule ? 'block' : 'none';
                document.getElementById('pickupDate').required = shouldSchedule;
                pickupSlotInput.required = shouldSchedule;
            });
        });

        document.querySelector('.list-header').addEventListener('click', (e) => {
            const header = e.target.closest('.sortable-header');
            if (!header) return;

            const sortKey = header.dataset.sortKey;

            if (currentSortKey === sortKey) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortKey = sortKey;
                currentSortOrder = 'desc';
            }

            updateSortIcons();
            resetAndFetchCustomers();
        });

        pincodeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            handlePincodeChange();
        });
        
        phoneInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            clearTimeout(phoneCheckTimeout);
            phoneMessage.style.display = 'none';
            submitBtn.disabled = false;
            const phoneNumber = e.target.value;
            const isAddMode = !customerIdInput.value;
            if (isAddMode && phoneNumber.length === 10) {
                phoneCheckTimeout = setTimeout(() => {
                    const customerExists = allCustomers.some(customer => customer.phone === phoneNumber);
                    if (customerExists) {
                        phoneMessage.textContent = 'This phone number is already registered.';
                        phoneMessage.style.display = 'block';
                        submitBtn.disabled = true;
                    }
                }, 500);
            }
        });

        document.getElementById('openAddModalBtn').addEventListener('click', openModalForAdd);
        document.getElementById('closeModalBtn').addEventListener('click', closeCustomerModal);
        cancelBtn.addEventListener('click', closeCustomerModal);
        
        editBtn.addEventListener('click', async () => {
            setFormState('edit');
            const customerId = customerIdInput.value;
            const customer = allCustomers.find(c => c._id === customerId);
            if (!customer) return;

            const currentAddress = customer.addresses.find(a => a.isCurrent) || customer.addresses[0];
            const pincode = pincodeInput.value;
            const selectedSocietyId = currentAddress?.society?._id || currentAddress?.society;

            if (pincode && pincode.length === 6) {
                try {
                    const response = await fetch(`/api/societies/by-pincode/${pincode}`);
                    const societiesForPincode = await response.json();
                    if (societiesForPincode.length > 0) {
                        pincodeMessage.textContent = 'Serviceable';
                        pincodeMessage.style.color = '#16a34a';
                        pincodeMessage.style.display = 'block';
                        renderSocieties(societiesForPincode, selectedSocietyId);
                    } else {
                        pincodeMessage.textContent = 'Non Serviceable';
                        pincodeMessage.style.color = '#ef4444';
                        pincodeMessage.style.display = 'block';
                        renderSocieties([]);
                    }
                } catch (error) {
                    console.error("Failed to fetch societies on edit:", error);
                    renderSocieties([]);
                }
            } else {
                renderSocieties([]);
            }
        });

        document.getElementById('closeOrderModalBtn').addEventListener('click', closeOrderModal);
        document.getElementById('cancelOrderBtn').addEventListener('click', closeOrderModal);
        document.getElementById('closeCustomerOrdersModalBtn').addEventListener('click', () => customerOrdersModal.style.display = 'none');
        
        document.getElementById('serviceCategorySelect').addEventListener('change', (e) => {
            if (!e.target.value) { document.getElementById('serviceInputContainer').style.display = 'none'; return; }
            renderServiceInputs(availableServices.find(s => s._id === e.target.value));
        });
        
        serviceTypeGroup.addEventListener('change', () => {
            const serviceId = document.getElementById('serviceCategorySelect').value;
            if (serviceId) renderServiceInputs(availableServices.find(s => s._id === serviceId));
        });

        document.getElementById('pickupDate').addEventListener('change', async (e) => {
            const selectedDate = e.target.value;
            pickupSlotContainer.innerHTML = `<div class="loading" style="padding: 10px; grid-column: 1 / -1;"><div class="spinner"></div></div>`;
            if (!selectedDate) {
                pickupSlotContainer.innerHTML = `<p style="grid-column: 1 / -1; color: #6b7280;">Select a date to see available slots.</p>`;
                return;
            }
            try {
                const res = await fetch(`/api/slots/status?date=${selectedDate}`);
                if (!res.ok) throw new Error('Failed to fetch slot availability.');
                const slots = await res.json();
                renderPickupSlots(slots);
            } catch (error) {
                pickupSlotContainer.innerHTML = `<p style="grid-column: 1 / -1; color: #ef4444;">Error loading slots.</p>`;
                console.error(error);
            }
        });

        pickupSlotContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.slot-card');
            if (!card || card.hasAttribute('disabled')) return;
            pickupSlotContainer.querySelectorAll('.slot-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            pickupSlotInput.value = card.dataset.slotId;
        });

        window.addEventListener('click', (e) => {
            if (e.target === customerModal) closeCustomerModal();
            if (e.target === orderModal) closeOrderModal();
            if (e.target === customerOrdersModal) customerOrdersModal.style.display = 'none';
        });

        async function initializePage() {
            try {
                const [socRes, servRes] = await Promise.all([fetch('/api/societies'), fetch('/api/services')]);
                if ([socRes, servRes].some(res => res.status === 401)) return window.location.href = '/';
                allSocieties = await socRes.json(); availableServices = await servRes.json();
                const serviceDropdown = document.getElementById('serviceCategorySelect');
                serviceDropdown.innerHTML = '<option value="" disabled selected>-- Select Service --</option>' + availableServices.map(s => `<option value="${s._id}">${s.categoryName}</option>`).join('');
                await fetchCustomers(true);
            } catch (error) {
                console.error('Failed to initialize page:', error);
                document.getElementById('loadingState').innerHTML = `<div class="empty-state"><h3>‚ö†Ô∏è Error</h3><p>Could not load page data. Please refresh.</p></div>`;
                document.getElementById('loadingState').style.display = 'flex'; document.getElementById('customerListContainer').style.display = 'none';
            }
        }
        
        initializePage();
    </script>
</body>

</html>